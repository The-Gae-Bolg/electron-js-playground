<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>CodePlay JS</title>
    <style>
        @font-face {
            font-family: 'Cascadia Code PL';
            src: url('CascadiaCodePL.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        body {
            margin: 0;
            padding: 0;
            font-family: 'Cascadia Code PL', 'Consolas', 'Monaco', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            background: #181c20;
            color: #e0e0e0;
        }
        .header {
            background: #23272e;
            color: #e0e0e0;
            padding: 10px 20px;
            font-size: 1.2em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px #0002;
        }
        .run-button {
            background: linear-gradient(90deg, #3a7bd5 0%, #00d2ff 100%);
            color: #fff;
            border: none;
            padding: 8px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-family: 'Cascadia Code PL', monospace;
            font-weight: bold;
            box-shadow: 0 2px 8px #0003;
            transition: background 0.3s, box-shadow 0.3s;
        }
        .run-button:hover {
            background: linear-gradient(90deg, #00d2ff 0%, #3a7bd5 100%);
            box-shadow: 0 4px 16px #0005;
        }
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
            background: #181c20;
        }
        .container.horizontal {
            flex-direction: row;
        }
        .container.vertical {
            flex-direction: column;
        }
        .resizer {
            background: #23272e;
            z-index: 1;
            transition: background 0.2s;
        }
        .container.horizontal .resizer {
            width: 6px;
            cursor: col-resize;
            height: 100%;
        }
        .container.vertical .resizer {
            height: 6px;
            cursor: row-resize;
            width: 100%;
        }
        .resizer:hover {
            background: #3a7bd5;
        }
        .editor-container, .output-container {
            display: flex;
            flex-direction: column;
            padding: 10px;
            box-sizing: border-box;
            min-width: 100px;
            min-height: 100px;
            background: #181c20;
        }
        .editor-container {
            border-right: 1px solid #23272e;
        }
        .editor {
            flex: 1 1 auto;
            border: 1px solid #23272e;
            border-radius: 6px;
            overflow: hidden;
            min-height: 50px;
            background: #23272e;
        }
        .output-container {
            background: #181c20;
        }
        .output {
            flex: 1 1 auto;
            background: #23272e;
            border: 1px solid #23272e;
            border-radius: 6px;
            padding: 14px 14px 14px 18px;
            overflow-y: auto;
            font-family: 'Cascadia Code PL', 'Consolas', 'Monaco', monospace;
            font-size: 15px;
            color: #e0e0e0;
            white-space: pre-wrap;
            min-height: 50px;
            box-shadow: 0 2px 8px #0002;
        }
        .output-title {
            margin: 0 0 10px 0;
            color: #7ecfff;
            font-size: 15px;
            font-weight: bold;
            letter-spacing: 0.5px;
            font-family: 'Cascadia Code PL', monospace;
        }
        .success {
            color: #7ecfff;
        }
        .error {
            color: #ff6b6b;
        }
        #output-content {
            margin: 0;
        }
        #toggle-orientation {
            color: #7ecfff;
            transition: color 0.2s;
        }
        #toggle-orientation:hover {
            color: #00d2ff;
        }
        /* Monaco Editor theme override */
        .monaco-editor, .monaco-editor-background, .monaco-editor .inputarea.ime-input {
            font-family: 'Cascadia Code PL', 'Consolas', 'Monaco', monospace !important;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>CodePlay JS</div>
        <button id="runButton" class="run-button">Run (Ctrl+Enter)</button>
    </div>
    
    <div class="container horizontal" id="container">
        <div class="editor-container" id="editor-container" style="width: 50%;">
            <div class="editor" id="editor"></div>
        </div>
        <div class="resizer" id="resizer"></div>
        <div class="output-container" id="output-container" style="width: 50%;">
            <div class="output-title">Variables</div>
            <div class="output" id="variables-output" style="margin-bottom:10px; min-height:40px; max-height:120px; overflow:auto;"></div>
            <div class="output-title">Console</div>
            <div class="output" id="output">
                <pre id="output-content">Run your code to see the results here...</pre>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.js"></script>
    <script>
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});
        let editor;
        let debounceTimeout;
        let autoRun = true;
        const runButton = document.getElementById('runButton');
        let lastCode = '';
        let orientation = 'horizontal';
        const container = document.getElementById('container');
        const editorContainer = document.getElementById('editor-container');
        const outputContainer = document.getElementById('output-container');
        const resizer = document.getElementById('resizer');
        const outputContent = document.getElementById('output-content');
        require(['vs/editor/editor.main'], function() {
            editor = monaco.editor.create(document.getElementById('editor'), {
                value: `// Write your JavaScript code here\n// For example:\nconst greeting = 'Hello, world!';\nconsole.log(greeting);\n\n// The result will appear in the console on the right`,
                language: 'javascript',
                theme: 'vs-dark',
                automaticLayout: true,
                minimap: { enabled: true },
                fontSize: 14,
                scrollBeyondLastLine: false,
                renderWhitespace: 'selection',
                tabSize: 2,
                lineNumbers: 'on',
            });
            editor.onDidChangeModelContent(() => {
                if (autoRun) {
                    clearTimeout(debounceTimeout);
                    debounceTimeout = setTimeout(executeCode, 500);
                }
            });
        });
        runButton.addEventListener('click', () => {
            autoRun = !autoRun;
            runButton.textContent = autoRun ? 'Auto: ON (Ctrl+Enter for manual run)' : 'Auto: OFF (Click to enable)';
            runButton.style.backgroundColor = autoRun ? '#4CAF50' : '#888';
            if (autoRun) executeCode();
        });
        runButton.textContent = 'Auto: ON (Ctrl+Enter for manual run)';
        window.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                executeCode();
            }
        });
        function executeCode() {
            const code = editor.getValue();
            outputContent.innerHTML = '';
            const variablesOutput = document.getElementById('variables-output');
            let varsHtml = '';
            try {
                let logs = [];
                const originalLog = console.log;
                const originalWarn = console.warn;
                const originalError = console.error;
                const originalInfo = console.info;
                const originalTable = console.table;
                // Utilidad para obtener la línea de ejecución
                function getLine() {
                    const err = new Error();
                    const stack = err.stack.split('\n');
                    for (let i = 2; i < stack.length; i++) {
                        const match = stack[i].match(/<anonymous>:(\d+):\d+/);
                        if (match) {
                            return parseInt(match[1], 10);
                        }
                    }
                    return '?';
                }
                // --- Captura variables ---
                const varNames = [];
                const varLines = {};
                const varRegex = /^(\s*)(let|const|var)\s+([a-zA-Z_$][\w$]*)/gm;
                let match;
                while ((match = varRegex.exec(code)) !== null) {
                    varNames.push(match[3]);
                    // Guardar la línea de declaración (basado en saltos de línea previos)
                    const before = code.slice(0, match.index);
                    varLines[match[3]] = (before.match(/\n/g) || []).length + 1;
                }
                // Creamos un objeto para exponer las variables
                let varsProxy = {};
                // Instrumentamos el código para exponer solo variables globales
                let instrumentedCode = code + '\n';
                varNames.forEach(v => {
                    instrumentedCode += `try { if (window.hasOwnProperty('${v}')) { window.__playground_vars__['${v}'] = ${v}; } else { window.__playground_vars__['${v}'] = ${v}; } } catch (e) { window.__playground_vars__['${v}'] = '<not evaluated>'; }\n`;
                });
                // Inicializamos el objeto global antes de ejecutar
                window.__playground_vars__ = {};
                // Redefinimos los métodos de consola
                console.log = function(...args) {
                    const line = getLine();
                    logs.push(`<b style=\"color:#7ecfff\">[Line ${line}] log:</b> ` + args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : String(arg)).join(' '));
                    originalLog.apply(console, args);
                };
                console.warn = function(...args) {
                    const line = getLine();
                    logs.push(`<b style=\"color:#ffe066\">[Line ${line}] warn:</b> ` + args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : String(arg)).join(' '));
                    originalWarn.apply(console, args);
                };
                console.error = function(...args) {
                    const line = getLine();
                    logs.push(`<b style=\"color:#ff6b6b\">[Line ${line}] error:</b> ` + args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : String(arg)).join(' '));
                    originalError.apply(console, args);
                };
                console.info = function(...args) {
                    const line = getLine();
                    logs.push(`<b style=\"color:#baffb8\">[Line ${line}] info:</b> ` + args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : String(arg)).join(' '));
                    originalInfo.apply(console, args);
                };
                console.table = function(data, columns) {
                    const line = getLine();
                    let html = `<b style=\"color:#baffb8\">[Line ${line}] table:</b><br>`;
                    if (Array.isArray(data)) {
                        if (data.length > 0 && typeof data[0] === 'object') {
                            const keys = columns || Object.keys(data[0]);
                            html += '<table style="border-collapse:collapse;margin-bottom:8px;">';
                            html += '<tr>' + keys.map(k => `<th style=\"border:1px solid #444;padding:2px 8px;color:#7ecfff;\">${k}</th>`).join('') + '</tr>';
                            data.forEach(row => {
                                html += '<tr>' + keys.map(k => `<td style=\"border:1px solid #444;padding:2px 8px;\">${row[k]}</td>`).join('') + '</tr>';
                            });
                            html += '</table>';
                        } else {
                            html += JSON.stringify(data);
                        }
                    } else if (typeof data === 'object' && data !== null) {
                        const keys = columns || Object.keys(data);
                        html += '<table style="border-collapse:collapse;margin-bottom:8px;">';
                        html += '<tr>' + keys.map(k => `<th style=\"border:1px solid #444;padding:2px 8px;color:#7ecfff;\">${k}</th>`).join('') + '</tr>';
                        html += '<tr>' + keys.map(k => `<td style=\"border:1px solid #444;padding:2px 8px;\">${data[k]}</td>`).join('') + '</tr>';
                        html += '</table>';
                    } else {
                        html += String(data);
                    }
                    logs.push(html);
                };
                // Ejecutamos el código instrumentado
                eval(instrumentedCode);
                // Mostrar variables y valores
                if (varNames.length > 0) {
                    varsHtml = varNames.map(v => {
                        let value = window.__playground_vars__ ? window.__playground_vars__[v] : '<not evaluated>';
                        if (!(v in window.__playground_vars__)) return '';
                        if (typeof value === 'function') {
                            // Detectar si es arrow function (fs()) o function normal
                            const arrowRegex = new RegExp(`(const|let|var)\\s+${v}\\s*=\\s*\\(`);
                            value = arrowRegex.test(code) ? 'fs()' : 'function ()';
                        } else if (typeof value === 'object' && value !== null) {
                            value = JSON.stringify(value);
                        }
                        return `<span style=\"color:#888\">[Line ${varLines[v]}]</span> <span style=\"color:#7ecfff\">${v}</span>: <span style=\"color:#baffb8\">${value}</span>`;
                    }).filter(Boolean).join('<br>');
                    if (!varsHtml) varsHtml = '<span style="color:#888">No global variables detected.</span>';
                } else {
                    varsHtml = '<span style="color:#888">No global variables detected.</span>';
                }
                variablesOutput.innerHTML = varsHtml;
                // ---
                console.log = originalLog;
                console.warn = originalWarn;
                console.error = originalError;
                console.info = originalInfo;
                console.table = originalTable;
                if (logs.length > 0) {
                    outputContent.innerHTML = logs.map(l => `<span style=\"color:#e0e0e0\">${l}</span>`).join('<br>');
                } else {
                    outputContent.innerHTML = '<span style="color:#888">No console messages detected.</span>';
                }
            } catch (error) {
                variablesOutput.innerHTML = '<span style="color:#888">No global variables detected.</span>';
                outputContent.innerHTML = `<span class=\"error\">✗ Execution error</span>\n\n${error}`;
            }
        }

        window.electron.ipcRenderer.on('code-result', (event, result) => {
            const code = editor.getValue();
            const outputContent = document.getElementById('output-content');
            if (result.success) {
                let output = `<span class=\"success\">✓ Successful execution</span>\n`;
                if (result.stdout) {
                    output += `<span style="color:#baffb8">${result.stdout}</span>\n`;
                }
                if (result.stderr) {
                    output += `<span class=\"error\">${result.stderr}</span>\n`;
                }
                outputContent.innerHTML = output;
            } else {
                outputContent.innerHTML = `<span class=\"error\">✗ Execution error</span>\n\n${result.error}`;
            }
        });
    </script>
</body>
</html>
