<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>CodePlay JS</title>
    <style>
        @font-face {
            font-family: 'Cascadia Code PL';
            src: url('CascadiaCodePL.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Cascadia Code PL', 'Consolas', 'Monaco', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            background: #181c20;
            color: #e0e0e0;
        }

        .header {
            background: #181c20;
            color: #e0e0e0;
            padding: 10px 20px;
            font-size: 1.2em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px #0002;
        }

        .run-button {
            background: linear-gradient(90deg, #3a7bd5 0%, #00d2ff 100%);
            color: #fff;
            border: none;
            padding: 8px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-family: 'Cascadia Code PL', monospace;
            font-weight: bold;
            box-shadow: 0 2px 8px #0003;
            transition: background 0.3s, box-shadow 0.3s;
        }

        .run-button:hover {
            background: linear-gradient(90deg, #00d2ff 0%, #3a7bd5 100%);
            box-shadow: 0 4px 16px #0005;
        }

        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
            background: #181c20;
        }

        .container.horizontal {
            flex-direction: row;
        }

        .container.vertical {
            flex-direction: column;
        }

        .resizer {
            background: #181c20;
            z-index: 1;
            transition: background 0.2s;
        }

        .container.horizontal .resizer {
            width: 6px;
            cursor: col-resize;
            height: 100%;
        }

        .container.vertical .resizer {
            height: 6px;
            cursor: row-resize;
            width: 100%;
        }

        .resizer:hover {
            background: #3a7bd5;
        }

        .editor-container,
        .output-container {
            display: flex;
            flex-direction: column;
            padding: 10px;
            box-sizing: border-box;
            min-width: 100px;
            min-height: 100px;
            background: #181c20;
        }

        .editor-container {
            border-right: 1px solid #181c20;
        }

        .editor {
            flex: 1 1 auto;
            border: 1px solid #181c20;
            border-radius: 6px;
            overflow: hidden;
            min-height: 50px;
            background: #181c20;
        }

        .output-container {
            background: #181c20;
        }

        .output {
            flex: 1 1 auto;
            background: #1e1e1e;
            border: 1px solid #23272e;
            border-radius: 6px;
            padding: 14px 14px 14px 18px;
            overflow-y: auto;
            font-family: 'Cascadia Code PL', 'Consolas', 'Monaco', monospace;
            font-size: 15px;
            color: #e0e0e0;
            white-space: pre-wrap;
            min-height: 50px;
            box-shadow: 0 2px 8px #0002;
        }

        .output-title {
            margin: 0 0 10px 0;
            color: #fff;
            font-size: 15px;
            font-weight: bold;
            letter-spacing: 0.5px;
            font-family: 'Cascadia Code PL', monospace;
        }

        .success {
            color: #7ecfff;
        }

        .error {
            color: #ff6b6b;
        }

        #output-content {
            margin: 0;
        }

        #toggle-orientation {
            color: #7ecfff;
            transition: color 0.2s;
        }

        #toggle-orientation:hover {
            color: #00d2ff;
        }

        /* Monaco Editor theme override */
        .editor,
        .output,
        .output-title,
        .run-button,
        .monaco-editor,
        .monaco-editor-background,
        .monaco-editor .inputarea.ime-input {
            font-family: 'Cascadia Code PL', 'Consolas', 'Monaco', monospace !important;
        }

        .switch-label {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 18px;
        }

        .switch-label input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #333;
            border-radius: 18px;
            transition: background 0.2s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 12px;
            width: 12px;
            left: 3px;
            bottom: 3px;
            background: #baffb8;
            border-radius: 50%;
            transition: transform 0.2s;
        }

        .switch-label input:checked+.slider {
            background: linear-gradient(90deg, #7ecfff 0%, #00d2ff 100%);
        }

        .switch-label input:checked+.slider:before {
            transform: translateX(16px);
        }

        .manual-hint {
            color: #fff;
            font-size: 0.75em;
            background: transparent;
            border-radius: 3px;
            padding: 0 6px;
            margin-left: 2px;
            font-family: 'Cascadia Code PL', monospace;
            opacity: 0.7;
            user-select: none;
            font-weight: normal;
            letter-spacing: 0.1em;
        }

        .menu-button {
            background: #181c20;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-family: 'Cascadia Code PL', monospace;
            font-weight: bold;
            box-shadow: 0 2px 8px #0003;
            transition: background 0.3s, box-shadow 0.3s;
            color: #fff;
        }

        .menu-button:hover {
            background: linear-gradient(90deg, #00d2ff 0%, #3a7bd5 100%);
            box-shadow: 0 4px 16px #0005;
        }
    </style>
</head>

<body>
    <div class="header">
        <div style="display: flex; align-items: center; gap: 15px;">
            <div class="menu-buttons" style="display: flex; gap: 10px;">
                <button id="new-file" class="menu-button" title="Nuevo archivo (Ctrl+N)">
                    <i class="fas fa-file"></i> Nuevo
                </button>
                <button id="open-file" class="menu-button" title="Abrir archivo (Ctrl+O)">
                    <i class="fas fa-folder-open"></i> Abrir
                </button>
                <button id="save-file" class="menu-button" title="Guardar (Ctrl+S)">
                    <i class="fas fa-save"></i> Guardar
                </button>
            </div>
            <span id="file-path" style="margin-left: 10px; font-size: 0.8em; color: #7ecfff; opacity: 0.7; font-family: 'Cascadia Code PL', monospace;">
                Sin título
            </span>
        </div>
        <div style="display: flex; align-items: center; gap: 6px;">
            <span id="jsLabel"
                style="font-size:0.75em; color:#7ecfff; opacity:0.7; font-family:'Cascadia Code PL', monospace;">JS</span>
            <label class="switch-label" title="TypeScript Mode">
                <input type="checkbox" id="tsSwitch">
                <span class="slider"></span>
            </label>
            <span id="tsLabel"
                style="font-size:0.75em; color:#7ecfff; opacity:0.3; font-family:'Cascadia Code PL', monospace;">TS</span>
        </div>
        <div style="display: flex; align-items: center; gap: 16px;">
            <span id="AutoRunLabel"
                style="font-size:0.75em; color:#7ecfff; opacity:0.7; font-family:'Cascadia Code PL', monospace;">Auto Run</span>
            <label class="switch-label" title="Auto Run">
                <input type="checkbox" id="autoRunSwitch" checked>
                <span class="slider"></span>
            </label>

            <span class="manual-hint">Press <b>Ctrl+Enter</b> for manual run</span>
        </div>
    </div>

    <div class="container horizontal" id="container">
        <div class="editor-container" id="editor-container" style="width: 50%;">
            <div class="editor" id="editor"></div>
        </div>
        <div class="resizer" id="resizer"></div>
        <div class="output-container" id="output-container" style="width: 50%;">
            <div class="output-title">Variables</div>
            <div class="output" id="variables-output"
                style="margin-bottom:10px; min-height:40px; max-height:120px; overflow:auto;"></div>
            <div class="output-title">Console</div>
            <div class="output" id="output">
                <pre style="font-family: 'Cascadia Code PL', Consolas, 'Courier New', monospace;"
                    id="output-content">Run your code to see the results here...</pre>
            </div>
        </div>
    </div>

    <script src="./node_modules/typescript/lib/typescript.js"></script>
    <script src="./node_modules/monaco-editor/min/vs/loader.js"></script>
    <script>
        require.config({ paths: { 'vs': './node_modules/monaco-editor/min/vs' } });
        let editor;
        let debounceTimeout;
        let autoRun = true;
        const autoRunSwitch = document.getElementById('autoRunSwitch');
        const tsSwitch = document.getElementById('tsSwitch');
        const jsLabel = document.getElementById('jsLabel');
        const tsLabel = document.getElementById('tsLabel');
        const AutoRunLabel = document.getElementById('AutoRunLabel');
        // Inicializa el editor en modo JavaScript
        let editorLanguage = 'javascript';
        tsSwitch.addEventListener('change', () => {
            editorLanguage = tsSwitch.checked ? 'typescript' : 'javascript';
            monaco.editor.setModelLanguage(editor.getModel(), editorLanguage);
            if (tsSwitch.checked) {
                jsLabel.style.opacity = '0.3';
                tsLabel.style.opacity = '0.7';
            } else {
                jsLabel.style.opacity = '0.7';
                tsLabel.style.opacity = '0.3';
            }
        });
        // Al cargar, asegúrate de que JS esté resaltado
        jsLabel.style.opacity = '0.7';
        tsLabel.style.opacity = '0.3';
        let lastCode = '';
        let orientation = 'horizontal';
        const container = document.getElementById('container');
        const editorContainer = document.getElementById('editor-container');
        const outputContainer = document.getElementById('output-container');
        const resizer = document.getElementById('resizer');
        const outputContent = document.getElementById('output-content');
        require(['vs/editor/editor.main'], function () {
            editor = monaco.editor.create(document.getElementById('editor'), {
                value: `// Write your JavaScript or TypeScript code here\n// For example:\nconst greeting: string = 'Hello, world!';\nconsole.log(greeting);\n\n// The result will appear in the console on the right`,
                language: 'javascript',
                theme: 'vs-dark',
                automaticLayout: true,
                minimap: { enabled: true },
                fontSize: 14,
                fontFamily: 'Cascadia Code PL',
                fontLigatures: true,
                lineHeight: 22,
                letterSpacing: 0.5,
                scrollBeyondLastLine: false,
                renderWhitespace: 'selection',
                tabSize: 2,
                lineNumbers: 'on',
                wordWrap: 'on',
                smoothScrolling: true,
                cursorSmoothCaretAnimation: true,
                mouseWheelZoom: true,
                renderLineHighlight: 'all',
                renderControlCharacters: true,
                matchBrackets: 'always',
                guides: {
                    indentation: true,
                    highlightActiveIndentation: true
                },
                quickSuggestions: true,
                suggestOnTriggerCharacters: true,
                parameterHints: { enabled: true },
                hover: { enabled: true },
                formatOnPaste: true,
                formatOnType: true,
                autoClosingBrackets: 'always',
                autoClosingQuotes: 'always',
                scrollbar: {
                    verticalScrollbarSize: 10,
                    horizontalScrollbarSize: 10
                }
            });
            editor.onDidChangeModelContent(() => {
                if (autoRun) {
                    clearTimeout(debounceTimeout);
                    debounceTimeout = setTimeout(executeCode, 500);
                }
            });
        });
        function updateAutoRunLabel() {
            if (autoRunSwitch.checked) {
                AutoRunLabel.style.opacity = '0.85';
            } else {
                AutoRunLabel.style.opacity = '0.3';
            }
        }
        updateAutoRunLabel();
        autoRunSwitch.addEventListener('change', () => {
            autoRun = autoRunSwitch.checked;
            updateAutoRunLabel();
            if (autoRun) executeCode();
        });
        window.addEventListener('keydown', function (e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                executeCode();
            }
        });
        function executeCode() {
            const code = editor.getValue();
            outputContent.innerHTML = '';
            const variablesOutput = document.getElementById('variables-output');
            let varsHtml = '';
            try {
                let logs = [];
                const originalLog = console.log;
                const originalWarn = console.warn;
                const originalError = console.error;
                const originalInfo = console.info;
                const originalTable = console.table;
                // Utilidad para obtener la línea de ejecución
                function getLine() {
                    const err = new Error();
                    const stack = err.stack.split('\n');
                    for (let i = 2; i < stack.length; i++) {
                        const match = stack[i].match(/<anonymous>:(\d+):\d+/);
                        if (match) {
                            return parseInt(match[1], 10);
                        }
                    }
                    return '?';
                }
                // --- Captura variables ---
                const varNames = [];
                const varLines = {};
                const varRegex = /^(\s*)(let|const|var)\s+([a-zA-Z_$][\w$]*)/gm;
                let match;
                while ((match = varRegex.exec(code)) !== null) {
                    varNames.push(match[3]);
                    // Guardar la línea de declaración (basado en saltos de línea previos)
                    const before = code.slice(0, match.index);
                    varLines[match[3]] = (before.match(/\n/g) || []).length + 1;
                }
                // Creamos un objeto para exponer las variables
                let varsProxy = {};
                // Instrumentamos el código para exponer solo variables globales
                let instrumentedCode = code + '\n';
                varNames.forEach(v => {
                    instrumentedCode += `try { if (window.hasOwnProperty('${v}')) { window.__playground_vars__['${v}'] = ${v}; } else { window.__playground_vars__['${v}'] = ${v}; } } catch (e) { window.__playground_vars__['${v}'] = '<not evaluated>'; }\n`;
                });
                // Inicializamos el objeto global antes de ejecutar
                window.__playground_vars__ = {};
                // Redefinimos los métodos de consola
                console.log = function (...args) {
                    const line = getLine();
                    logs.push(`<span style=\"color:#7ecfff\">[Line ${line}] log:</span> ` + args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : String(arg)).join(' '));
                    originalLog.apply(console, args);
                };
                console.warn = function (...args) {
                    const line = getLine();
                    logs.push(`<span style=\"color:#ffe066\">[Line ${line}] warn:</span> ` + args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : String(arg)).join(' '));
                    originalWarn.apply(console, args);
                };
                console.error = function (...args) {
                    const line = getLine();
                    logs.push(`<span style=\"color:#ff6b6b\">[Line ${line}] error:</span> ` + args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : String(arg)).join(' '));
                    originalError.apply(console, args);
                };
                console.info = function (...args) {
                    const line = getLine();
                    logs.push(`<span style=\"color:#baffb8\">[Line ${line}] info:</span> ` + args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : String(arg)).join(' '));
                    originalInfo.apply(console, args);
                };
                console.table = function (data, columns) {
                    const line = getLine();
                    let html = `<span style=\"color:#baffb8\">[Line ${line}] table:</span><br>`;
                    if (Array.isArray(data)) {
                        if (data.length > 0 && typeof data[0] === 'object') {
                            const keys = columns || Object.keys(data[0]);
                            html += '<table style="border-collapse:collapse;margin-bottom:8px;">';
                            html += '<tr>' + keys.map(k => `<th style=\"border:1px solid #444;padding:2px 8px;color:#7ecfff;\">${k}</th>`).join('') + '</tr>';
                            data.forEach(row => {
                                html += '<tr>' + keys.map(k => `<td style=\"border:1px solid #444;padding:2px 8px;\">${row[k]}</td>`).join('') + '</tr>';
                            });
                            html += '</table>';
                        } else {
                            html += JSON.stringify(data);
                        }
                    } else if (typeof data === 'object' && data !== null) {
                        const keys = columns || Object.keys(data);
                        html += '<table style="border-collapse:collapse;margin-bottom:8px;">';
                        html += '<tr>' + keys.map(k => `<th style=\"border:1px solid #444;padding:2px 8px;color:#7ecfff;\">${k}</th>`).join('') + '</tr>';
                        html += '<tr>' + keys.map(k => `<td style=\"border:1px solid #444;padding:2px 8px;\">${data[k]}</td>`).join('') + '</tr>';
                        html += '</table>';
                    } else {
                        html += String(data);
                    }
                    logs.push(html);
                };
                // --- COMPILACIÓN TS ---
                let codeToEval = instrumentedCode;
                if (editorLanguage === 'typescript') {
                    try {
                        const transpileResult = window.ts.transpileModule(instrumentedCode, { compilerOptions: { module: window.ts.ModuleKind.None, target: window.ts.ScriptTarget.ESNext } });
                        if (transpileResult.diagnostics && transpileResult.diagnostics.length > 0) {
                            let tsErrors = transpileResult.diagnostics.map(d => d.messageText).join('<br>');
                            outputContent.innerHTML = `<span class=\"error\">TypeScript compile error:</span><br>${tsErrors}`;
                            variablesOutput.innerHTML = '<span style="color:#888">No global variables detected.</span>';
                            // Restaurar consola
                            console.log = originalLog;
                            console.warn = originalWarn;
                            console.error = originalError;
                            console.info = originalInfo;
                            console.table = originalTable;
                            return;
                        }
                        codeToEval = transpileResult.outputText;
                    } catch (tsErr) {
                        outputContent.innerHTML = `<span class=\"error\">TypeScript transpile error:</span><br>${tsErr}`;
                        variablesOutput.innerHTML = '<span style="color:#888">No global variables detected.</span>';
                        // Restaurar consola
                        console.log = originalLog;
                        console.warn = originalWarn;
                        console.error = originalError;
                        console.info = originalInfo;
                        console.table = originalTable;
                        return;
                    }
                }
                // Ejecutamos el código (ya JS si era TS)
                eval(codeToEval);
                // Mostrar variables y valores
                if (varNames.length > 0) {
                    varsHtml = varNames.map(v => {
                        let value = window.__playground_vars__ ? window.__playground_vars__[v] : '<not evaluated>';
                        if (!(v in window.__playground_vars__)) return '';
                        if (typeof value === 'function') {
                            // Detectar si es arrow function (fs()) o function normal
                            const arrowRegex = new RegExp(`(const|let|var)\\s+${v}\\s*=\\s*\\(`);
                            value = arrowRegex.test(code) ? 'fs()' : 'function ()';
                        } else if (typeof value === 'object' && value !== null) {
                            value = JSON.stringify(value);
                        }
                        return `<span style=\"color:#fff\">[Line ${varLines[v]}]</span> <span style=\"color:#7ecfff\">${v}</span>: <span style=\"color:#baffb8\">${value}</span>`;
                    }).filter(Boolean).join('<br>');
                    if (!varsHtml) varsHtml = '<span style="color:#888">No global variables detected.</span>';
                } else {
                    varsHtml = '<span style="color:#888">No global variables detected.</span>';
                }
                variablesOutput.innerHTML = varsHtml;
                // Mostrar logs de la consola si existen
                if (logs.length > 0) {
                    outputContent.innerHTML = logs.map(l => `<span style="color:#e0e0e0">${l}</span>`).join('<br>');
                } else {
                    outputContent.innerHTML = '<span style="color:#888">No console messages detected.</span>';
                }
            } catch (error) {
                variablesOutput.innerHTML = '<span style="color:#888">No global variables detected.</span>';
                outputContent.innerHTML = `<span class="error">✗ Execution error</span>\n\n${error}`;
            } finally {
                // Restaurar los métodos originales de la consola
                console.log = originalLog;
                console.warn = originalWarn;
                console.error = originalError;
                console.info = originalInfo;
                console.table = originalTable;
            }
        }

        window.electron.ipcRenderer.on('code-result', (event, result) => {
            const code = editor.getValue();
            const outputContent = document.getElementById('output-content');
            if (result.success) {
                let output = `<span class=\"success\">✓ Successful execution</span>\n`;
                if (result.stdout) {
                    output += `<span style="color:#baffb8">${result.stdout}</span>\n`;
                }
                if (result.stderr) {
                    output += `<span class=\"error\">${result.stderr}</span>\n`;
                }
                outputContent.innerHTML = output;
            } else {
                outputContent.innerHTML = `<span class=\"error\">✗ Execution error</span>\n\n${result.error}`;
            }
        });

        // Manejo de archivos
        document.getElementById('new-file').addEventListener('click', async () => {
            const result = await window.electron.fileSystem.newFile();
            if (result) {
                editor.setValue(result.content);
                document.getElementById('file-path').textContent = 'Sin título';
                currentFilePath = null;
            }
        });

        document.getElementById('open-file').addEventListener('click', async () => {
            const result = await window.electron.fileSystem.openFile();
            if (result) {
                editor.setValue(result.content);
                document.getElementById('file-path').textContent = result.filePath || 'Sin título';
                currentFilePath = result.filePath;
                // Actualizar el modo del editor según la extensión del archivo
                if (result.filePath) {
                    const ext = result.filePath.split('.').pop().toLowerCase();
                    if (ext === 'ts' || ext === 'tsx') {
                        tsSwitch.checked = true;
                        editorLanguage = 'typescript';
                        jsLabel.style.opacity = '0.3';
                        tsLabel.style.opacity = '0.7';
                    } else {
                        tsSwitch.checked = false;
                        editorLanguage = 'javascript';
                        jsLabel.style.opacity = '0.7';
                        tsLabel.style.opacity = '0.3';
                    }
                    monaco.editor.setModelLanguage(editor.getModel(), editorLanguage);
                }
            }
        });

        document.getElementById('save-file').addEventListener('click', async () => {
            const content = editor.getValue();
            const result = await window.electron.fileSystem.saveFile(content);
            if (result) {
                document.getElementById('file-path').textContent = result;
                currentFilePath = result;
            }
        });

        // Manejar atajos de teclado
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                document.getElementById('save-file').click();
            } else if ((e.ctrlKey || e.metaKey) && e.key === 'o') {
                e.preventDefault();
                document.getElementById('open-file').click();
            } else if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                document.getElementById('new-file').click();
            }
        });

        // Variable para rastrear el archivo actual
        let currentFilePath = null;
    </script>
</body>

</html>